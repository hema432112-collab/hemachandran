/* ===============================
   CANVAS ANIMATION CONFIGURATION
================================ */
const frameCount = 200;

// Path to your image sequence - UPDATE THIS PATH TO MATCH YOUR IMAGES FOLDER
const imagePath = index =>
  `images/ezgif-frame-${String(index).padStart(3, "0")}.jpg`;

const canvas = document.getElementById("scroll-canvas");
const ctx = canvas.getContext("2d");

const images = [];
let imagesLoaded = 0;
let currentFrame = 0;

/* ===============================
   RETINA CANVAS SETUP
================================ */
function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();

  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;

  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener("resize", resizeCanvas);

/* ===============================
   IMAGE PRELOAD
================================ */
for (let i = 1; i <= frameCount; i++) {
  const img = new Image();
  img.src = imagePath(i);

  img.onload = () => {
    imagesLoaded++;

    // Start animation ONLY after all images load
    if (imagesLoaded === frameCount) {
      resizeCanvas();
      drawImage(images[0]);
      requestAnimationFrame(animate);
    }
  };

  img.onerror = () => {
    console.error(`Failed to load image: ${imagePath(i)}`);
  };

  images.push(img);
}

/* ===============================
   DRAW IMAGE ON CANVAS
================================ */
function drawImage(img) {
  if (!img.complete) return;
  
  const dpr = window.devicePixelRatio || 1;
  const canvasWidth = canvas.width / dpr;
  const canvasHeight = canvas.height / dpr;

  const imgRatio = img.width / img.height;
  const canvasRatio = canvasWidth / canvasHeight;

  let drawWidth, drawHeight;

  if (imgRatio > canvasRatio) {
    drawHeight = canvasHeight;
    drawWidth = imgRatio * drawHeight;
  } else {
    drawWidth = canvasWidth;
    drawHeight = drawWidth / imgRatio;
  }

  const x = (canvasWidth - drawWidth) / 2;
  const y = (canvasHeight - drawHeight) / 2;

  ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  ctx.drawImage(img, x, y, drawWidth, drawHeight);
}

/* ===============================
   SCROLL PROGRESS CALCULATION
================================ */
function getScrollProgress() {
  const section = document.querySelector(".hero-section");
  const scrollTop = window.scrollY;
  const sectionTop = section.offsetTop;
  const sectionHeight = section.offsetHeight - window.innerHeight;

  return Math.min(
    Math.max((scrollTop - sectionTop) / sectionHeight, 0),
    1
  );
}

/* ===============================
   ANIMATION LOOP
================================ */
function animate() {
  const scrollProgress = getScrollProgress();
  const frameIndex = Math.floor(scrollProgress * (frameCount - 1));

  if (frameIndex !== currentFrame && images[frameIndex]) {
    currentFrame = frameIndex;
    drawImage(images[currentFrame]);
  }

  requestAnimationFrame(animate);
}

/* ===============================
   NAVIGATION FUNCTIONALITY
================================ */
const hamburger = document.querySelector('.hamburger');
const navMenu = document.querySelector('.nav-menu');
const navLinks = document.querySelectorAll('.nav-link');
const navbar = document.querySelector('.navbar');

// Toggle mobile menu
hamburger.addEventListener('click', () => {
  hamburger.classList.toggle('active');
  navMenu.classList.toggle('active');
});

// Close menu when clicking a link
navLinks.forEach(link => {
  link.addEventListener('click', () => {
    hamburger.classList.remove('active');
    navMenu.classList.remove('active');
  });
});

// Navbar scroll effect
window.addEventListener('scroll', () => {
  if (window.scrollY > 100) {
    navbar.classList.add('scrolled');
  } else {
    navbar.classList.remove('activescrolled');
  }
});

/* ===============================
   SCROLL REVEAL ANIMATIONS
================================ */
const observerOptions = {
  threshold: 0.1,
  rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.style.opacity = '1';
      entry.target.style.transform = 'translateY(0)';
    }
  });
}, observerOptions);

// Observe all sections
document.addEventListener('DOMContentLoaded', () => {
  const sections = document.querySelectorAll('.section');
  sections.forEach(section => {
    section.style.opacity = '0';
    section.style.transform = 'translateY(30px)';
    section.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
    observer.observe(section);
  });
});

/* ===============================
   SMOOTH SCROLL ENHANCEMENTS
================================ */
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      const navbarHeight = navbar.offsetHeight;
      const targetPosition = target.offsetTop - navbarHeight;
      
      window.scrollTo({
        top: targetPosition,
        behavior: 'smooth'
      });
    }
  });
});

/* ===============================
   CARD HOVER EFFECTS
================================ */
document.querySelectorAll('.skill-card, .project-card, .cert-card, .education-card').forEach(card => {
  card.addEventListener('mouseenter', function() {
    this.style.transform = 'translateY(-10px) scale(1.02)';
  });
  
  card.addEventListener('mouseleave', function() {
    this.style.transform = 'translateY(0) scale(1)';
  });
});

/* ===============================
   PERFORMANCE OPTIMIZATION
================================ */
let ticking = false;

window.addEventListener('scroll', () => {
  if (!ticking) {
    window.requestAnimationFrame(() => {
      ticking = false;
    });
    ticking = true;
  }
});

/* ===============================
   LOADING INDICATOR
================================ */
window.addEventListener('load', () => {
  document.body.classList.add('loaded');
  console.log('Portfolio website loaded successfully! ðŸš€');
  console.log(`Canvas animation with ${frameCount} frames`);
  console.log(`Images loaded: ${imagesLoaded}/${frameCount}`);
});

/* ===============================
   GEMINI CHATBOT LOGIC
================================ */
// Using a dynamic import to ensure it works within your existing script
import("https://esm.run/@google/generative-ai").then(module => {
    const { GoogleGenerativeAI } = module;

    const API_KEY = "AIzaSyBy48yyydiJ7uWLgftzjIBOXne8zSEE0lY"; 
    const genAI = new GoogleGenerativeAI(API_KEY);

    // Add your system prompt here
const systemPrompt = `
PERSONAL INFORMATION

Name: Hemachandran KT
Profession: Fresher Electrical and Electronics Engineer
Contact: +91-6383207363
Email: hema432112@gmail.com
Address: 3-895, Gandhinagar, R.K.PET, Thiruvallur District, Tamil Nadu - 631303
Gender: Male
Date of Birth: 12.12.2003
Marital Status: Unmarried
Father's Name: Thirumalai K.M
Mother's Name: Uma KT

OBJECTIVE
Dedicated Electrical Engineering graduate seeking to contribute technical skills and fresh perspectives to reputed organization. Aspires to support operational excellence while developing core engineering competencies.
EDUCATION QUALIFICATIONS

BE (EEE) - Currently pursuing from TPGIT, Vellore, Tamil Nadu (affiliated to Anna University, Chennai)

CGPA: 7.1 (till 6th semester)


Higher Secondary Certificate (HSC) - The Sri Ayyan Vidyasaram School, R.K.Pet, TN (Tamil Nadu State Board)

Percentage: 86.5%
Passed: March 2021


Secondary School Leaving Certificate - Vethathiri Maharishi Higher Secondary School, S.V.G.Puram

Percentage: 84%
Passed: March 2019



AREAS OF INTEREST

Embedded System & Firmware Development
PLC Programming and Industrial Automation
SCADA and HMI Design

TECHNICAL SKILLS

Circuit design
MATLAB
Basic PLC concepts
Ladder logic
SCADA

SOFT SKILLS

Problem solving & Analytical Thinking
Effective Communication skills
Team collaboration

PROJECT DETAILS

Smart Energy Meter using IoT - TPGIT (2 weeks, May 2025)
Smart Agricultural System - TPGIT (3 weeks, October 2025)
Final Year Project (Proposed): "Quadratic High Gain Boost Converter for Grid Tie PV Panel" - TPGIT

PAPER PRESENTATION

Topic: "E Vehicles and Battery Management Systems"
Event: Symposium at TPGIT
Date: April 2025

HOBBIES

Playing cricket
Watching movies
Traveling and trekking"
`;

    const model = genAI.getGenerativeModel({
        model: "gemini-2.5-flash",
        systemInstruction: systemPrompt,
    });

    const chatSession = model.startChat({ history: [] });

    // UI Elements
    const chatToggle = document.getElementById('chat-toggle');
    const chatContainer = document.getElementById('chat-container');
    const closeChat = document.getElementById('close-chat');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');

    // Toggle Window Logic - Fixed
    if (chatToggle && chatContainer) {
        chatToggle.addEventListener('click', (e) => {
            e.preventDefault();
            chatContainer.classList.toggle('chat-hidden');
            console.log("Chat toggled"); // Debug check
        });
    }

    if (closeChat) {
        closeChat.addEventListener('click', () => {
            chatContainer.classList.add('chat-hidden');
        });
    }

    async function handleChat() {
        const text = chatInput.value.trim();
        if (!text) return;

        appendMessage(text, true);
        chatInput.value = '';

        try {
            const result = await chatSession.sendMessage(text);
            const response = await result.response;
            appendMessage(response.text(), false);
        } catch (err) {
            appendMessage("I'm having trouble connecting.", false);
            console.error("Gemini Error:", err);
        }
    }

    function appendMessage(text, isUser) {
        const msg = document.createElement('div');
        msg.classList.add('message', isUser ? 'user-msg' : 'bot-msg');
        msg.innerText = text;
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatSend.addEventListener('click', handleChat);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChat();
    });
    
}).catch(err => console.error("Failed to load Gemini SDK:", err));